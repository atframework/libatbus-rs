# 针对Lockstep场景的优化

+ 需要提供接口由上层主动触发重传。
  + 允许帧同步的frame_tick更加及时地发起重传。
+ 鉴权
  + 服务端采用Lockstep service层面的token鉴权
  + 客户端网络层鉴权使用 libatbus-rs 的基于 [服务发现](../discovery.md) 的网络层鉴权
    + 服务器创建房间时，同时分配 [服务发现](../discovery.md) 层的client的名字和Token。
  + 区分角色，服务器角色要比客户端权限更高
    + 仅服务器允许强制销毁房间、创建房间
+ UDP连接使用包冗余+向前纠错（FEC）
  + 包冗余可以通过统计丢包率动态变化。
  + 向前纠错（FEC）的帧数可以设置为当前冗余倍率/包冗余
    + 首个版本实现为按倍率冗余，即每个包发出N帧。
    + 后续版本可以增加使用XOR的冗余方式，即每N个包多发一个FEC冗余包，采用XOR恢复错误包。（每N个包允许丢失一个，同QUIC的方式）
  + 每个客户端连接单独评估倍率
+ 定时器优化
  + 针对Lockstep场景的帧率，使用简单的时间轮定时器
    + 时间轮只使用一层，1/120s为一个tick。
    + 针对1/2/3/.../30/60等可以被120整除的帧率的房间，设置 `120/帧率` 个固定定时器。
  + 对于其他帧率，使用时间轮定时器。
+ P2P加速（低优先级）。
  + 同房间玩家间可以通过类似Gossip协议的方式互传帧同步包。
  + P2P鉴权
    + 由客户端上报，服务端转发
  + 局域网加速。
    + 同子网检测。
  + UPnP/SSDP（很多路由禁用）。
  + 打洞: RFC5780 侦测NAT规则（低优先级）。
+ 重要赛事冗余
  + 由Lockstep service层面分配主备，故障时切到备机。

## 关于混合使用包冗余+向前纠错（FEC）

在仅有向前纠错（FEC）的场景中，我们在游戏对局的过程中发现了偶发的玩家网络包抖动。这个时候如果仅仅有向前纠错（FEC），等到下一帧再通过纠错补偿已经会延迟一帧了。
通过网络层包冗余可以减少这种情况得抖动。

> 参考: [KCP最佳实践][1]

[1]: https://github.com/skywind3000/kcp/wiki/KCP-Best-Practice
